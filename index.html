<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Know Your Beat: Community Policing in Chicago</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Barlow+Semi+Condensed:wght@600;700&display=swap">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>
  <script type="text/javascript" src="data/cpddistrictsfinalpline.js"></script>
  <script type="text/javascript" src="data/beats.js"></script>

  <style>
    body {
      padding: 0;
      margin: 0;
    }
    html, body, #map {
      height: 100%;
    }
    .leaflet-tooltip.beat-label,
    .leaflet-tooltip.district-label {
      background: transparent;
      border: none;
      box-shadow: none;
      padding: 0;
      font-family: 'Barlow Semi Condensed', sans-serif;
      font-weight: 600;
      color: #2a2a2a;
      letter-spacing: 0.03em;
      white-space: nowrap;
      text-shadow:
        -1px -1px 0 #fff,
         1px -1px 0 #fff,
        -1px  1px 0 #fff,
         1px  1px 0 #fff,
         0   -1px 0 #fff,
         0    1px 0 #fff,
        -1px  0   0 #fff,
         1px  0   0 #fff,
         0    0   4px #fff,
         0    0   6px #fff,
         0    0  10px #fff,
         0    0  14px #fff,
         0    0  20px #fff;
    }
    .leaflet-tooltip.beat-label {
      font-size: 13px;
    }
    .leaflet-tooltip.district-label {
      font-size: 20px;
      font-weight: 700;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    var map = L.map('map').setView([41.878, -87.657], 14);

    var allBlayer = [];
    var allDlayer = [];

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://openstreetmap.org">OpenStreetMap</a> contributors, ' +
        '&copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd'
    }).addTo(map);

    function onEachFeature(feature, layer) {
      if (feature.properties && feature.properties.Beat) {
        layer.bindPopup(feature.properties.description +
          '<a href="https://capsure.opencityapps.org/district/' + feature.properties.District + '">' +
          'Attend This Beat Meeting</a>');
        allBlayer.push(layer);
      } else if (feature.properties && feature.properties.distname) {
        allDlayer.push(layer);
      }
    }

    var districtColors = {
      1:  '#FF0040',
      2:  '#FF00FF',
      3:  '#0000FF',
      4:  '#0B0B61',
      5:  '#00FF40',
      6:  '#80FF00',
      7:  '#0B615E',
      8:  '#4C0B5F',
      9:  '#0B6121',
      10: '#E31A1C',
      11: '#610B4B',
      12: '#FF8000',
      14: '#00FFFF',
      15: '#21610B',
      16: '#FF0000',
      17: '#FFFF00',
      18: '#5E610B',
      19: '#61380B',
      20: '#800026',
      21: '#BD0026',
      22: '#00B3A0',
      24: '#6A5ACD',
      25: '#FFEDA0'
    };

    function getColor(d) {
      return districtColors[parseInt(d, 10)] || '#610B21';
    }

    function dStyle(feature) {
      return {
        color: '#F2F2F2',
        weight: 3.5,
        opacity: 1,
        dashArray: '4,9',
        fillOpacity: 0
      };
    }

    function bStyle(feature) {
      return {
        color: '#585858',
        weight: 2.5,
        opacity: 0.55,
        fillColor: getColor(feature.properties.District),
        fillOpacity: 0.30
      };
    }

    L.geoJSON(beats, {
      style: bStyle,
      onEachFeature: onEachFeature
    }).addTo(map);

    L.geoJSON(districts, {
      style: dStyle,
      onEachFeature: onEachFeature
    }).addTo(map);

    var beatLabelGroup = L.layerGroup();
    var districtLabelGroup = L.layerGroup();

    for (var i = 0; i < allBlayer.length; i++) {
      L.tooltip({
        permanent: true,
        direction: 'center',
        className: 'beat-label'
      })
      .setContent(allBlayer[i].feature.properties['Beat Number'])
      .setLatLng(allBlayer[i].getBounds().getCenter())
      .addTo(beatLabelGroup);
    }

    for (var i = 0; i < allDlayer.length; i++) {
      L.tooltip({
        permanent: true,
        direction: 'center',
        className: 'district-label'
      })
      .setContent(allDlayer[i].feature.properties.distname)
      .setLatLng(allDlayer[i].getBounds().getCenter())
      .addTo(districtLabelGroup);
    }

    beatLabelGroup.addTo(map);

    map.on('zoomend', function () {
      var zoom = map.getZoom();
      if (zoom >= 13) {
        if (!map.hasLayer(beatLabelGroup)) map.addLayer(beatLabelGroup);
        if (map.hasLayer(districtLabelGroup)) map.removeLayer(districtLabelGroup);
      } else if (zoom < 10) {
        if (map.hasLayer(beatLabelGroup)) map.removeLayer(beatLabelGroup);
        if (map.hasLayer(districtLabelGroup)) map.removeLayer(districtLabelGroup);
      } else {
        if (map.hasLayer(beatLabelGroup)) map.removeLayer(beatLabelGroup);
        if (!map.hasLayer(districtLabelGroup)) map.addLayer(districtLabelGroup);
      }
    });

    function onLocationFound(e) {
      var bounds = L.latLngBounds([
        [41.562, -88.050],
        [42.204, -87.437]
      ]);
      if (bounds.contains(e.latlng)) {
        var radius = e.accuracy / 2;
        L.marker(e.latlng).addTo(map)
          .bindPopup('This is you!').openPopup();
        L.circle(e.latlng, {radius: radius}).addTo(map);
        map.setView(e.latlng);
      }
    }

    function onLocationError(e) {
      console.warn('Geolocation error:', e.message);
    }

    map.on('locationfound', onLocationFound);
    map.on('locationerror', onLocationError);

    map.locate({setView: false, maxZoom: 16});
  </script>
</body>
</html>
